// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SystemRole {
  super_admin
  system_admin
  user

  @@map("system_role_type")
}

model User {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email            String    @unique
  firstName        String    @map("first_name")
  secondName       String?   @map("second_name")
  lastName         String    @map("last_name")
  secondLastName   String?   @map("second_last_name")
  phone            String
  nuid             String    @unique // National ID
  addresses        Address[]
  // Additional Information
  birthDate        DateTime? @map("birth_date") @db.Date
  gender           String?
  nationality      String?
  birthPlace       String?   @map("place_of_birth")
  placeOfResidence String?   @map("place_of_residence")
  occupation       String?
  maritalStatus    String?   @map("marital_status")
  userStatus       String    @default("disabled") @map("user_status")

  // Secure Information
  passwordHash  String  @map("password_hash")
  recoveryPhone String? @map("recovery_phone")
  recoveryEmail String? @map("recovery_email")

  // System Role
  systemRole SystemRole @default(user) @map("system_role")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  refreshTokens      RefreshToken[]
  tenantMembers      TenantMember[]
  otpSecret          OTPSecret?
  emailVerifications EmailVerification[]
  otherInformation   OtherInformation?
  ssoSessions        SSOSession[]
  authCodes          AuthCode[]
  appSessions        AppSession[]
  userAppAccess      UserAppAccess[]

  @@map("users")
}

model Address {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  country    String
  province   String
  city       String
  detail     String
  postalCode String?  @map("postal_code")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model OtherInformation {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  data      Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("other_information")
}

model RefreshToken {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  tokenHash       String   @unique @map("token_hash")
  clientId        String?  @map("client_id")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt       DateTime @map("expires_at") @db.Timestamptz(6)
  revoked         Boolean  @default(false)
  previousTokenId String?  @map("previous_token_id") @db.Uuid
  ip              String?
  userAgent       String?  @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  members       TenantMember[]
  roles         Role[]
  authCodes     AuthCode[]
  appSessions   AppSession[]
  tenantApps    TenantApp[]
  userAppAccess UserAppAccess[]

  @@map("tenants")
}

model TenantMember {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String // admin, member, etc.
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("tenant_members")
}

model Role {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions Permission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId        String   @map("role_id") @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  resource      String
  action        String
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  role        Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([roleId, applicationId, resource, action])
  @@index([roleId])
  @@index([applicationId])
  @@map("permissions")
}

model OTPSecret {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @unique @map("user_id") @db.Uuid
  secret      String
  verified    Boolean  @default(false)
  backupCodes String[] @map("backup_codes")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_secrets")
}

model EmailVerification {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  email     String
  verified  Boolean  @default(false)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verifications")
}

model SSOSession {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken   String   @unique @map("session_token")
  userId         String   @map("user_id") @db.Uuid
  ip             String?
  userAgent      String?  @map("user_agent")
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActivityAt DateTime @default(now()) @map("last_activity_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
  @@index([expiresAt])
  @@map("sso_sessions")
}

model AuthCode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique @db.VarChar(255)
  userId      String   @map("user_id") @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  appId       String   @map("app_id") @db.VarChar(100)
  redirectUri String   @map("redirect_uri")
  used        Boolean  @default(false)
  expiresAt   DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([expiresAt, used])
  @@index([userId])
  @@index([tenantId])
  @@map("auth_codes")
}

model AppSession {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken   String   @unique @map("session_token")
  appId          String   @map("app_id") @db.VarChar(100)
  userId         String   @map("user_id") @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  role           String
  ip             String?
  userAgent      String?  @map("user_agent")
  expiresAt      DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActivityAt DateTime @default(now()) @map("last_activity_at") @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([appId, userId])
  @@index([userId])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("app_sessions")
}

model Application {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  appId       String   @unique @map("app_id") @db.VarChar(100) // 'crm', 'admin', 'analytics'
  name        String
  url         String
  description String?
  logoUrl     String?  @map("logo_url")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenantApps    TenantApp[]
  userAppAccess UserAppAccess[]
  resources     AppResource[]
  permissions   Permission[]

  @@index([appId])
  @@index([isActive])
  @@map("applications")
}

model AppResource {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  resource      String   @db.VarChar(100)
  action        String   @db.VarChar(100)
  description   String?
  category      String?  @db.VarChar(50)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, resource, action])
  @@index([applicationId, isActive])
  @@map("app_resources")
}

model TenantApp {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  isEnabled     Boolean  @default(true) @map("is_enabled")
  config        Json? // Configuración específica por tenant si es necesario
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([tenantId, applicationId])
  @@index([tenantId])
  @@index([applicationId])
  @@index([isEnabled])
  @@map("tenant_apps")
}

model UserAppAccess {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  grantedAt     DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy     String?  @map("granted_by") @db.Uuid // userId del admin que otorgó acceso

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId, applicationId])
  @@index([userId])
  @@index([tenantId])
  @@index([applicationId])
  @@index([userId, tenantId])
  @@map("user_app_access")
}
